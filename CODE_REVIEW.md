# 코드 검토 및 분석 보고서

## 📋 프로젝트 개요

**프로젝트명**: 오늘약국 (TodayPharmacy)  
**기술 스택**: Next.js 14, TypeScript, Supabase, Tailwind CSS  
**목적**: 실시간 약국 영업 정보 검색 서비스 (SEO/AEO 최적화)

---

## ✅ 강점 및 잘 구현된 부분

### 1. **아키텍처 및 구조**
- ✅ Next.js App Router 기반의 현대적인 구조
- ✅ 타입 안정성을 위한 TypeScript 전면 적용
- ✅ 컴포넌트와 비즈니스 로직의 명확한 분리
- ✅ 서버/클라이언트 컴포넌트 적절한 분리

### 2. **SEO/AEO 최적화**
- ✅ 동적 sitemap 생성 (10k 청크 단위)
- ✅ JSON-LD 구조화 데이터 (Pharmacy, FAQPage)
- ✅ 동적 메타데이터 생성 (시간/요일 기반)
- ✅ 페이지네이션 지원 (크롤러 친화적)
- ✅ AI 생성 콘텐츠 통합 (Gemini API)

### 3. **사용자 경험 (UX)**
- ✅ 무한 스크롤 + 페이지네이션 병행
- ✅ 실시간 영업 상태 표시
- ✅ 거리 기반 정렬 및 필터링
- ✅ 모바일 친화적 디자인 (48px 터치 영역)
- ✅ 위치 권한 거부 시 대안 제공

### 4. **데이터 관리**
- ✅ 공공데이터 API 동기화 스크립트
- ✅ Supabase를 통한 효율적인 데이터 관리
- ✅ 배치 업서트 최적화 (400건 단위)
- ✅ 지역 정규화 로직

### 5. **성능 최적화**
- ✅ SSR을 통한 초기 로딩 최적화
- ✅ 클라이언트 사이드 필터링 (메모이제이션)
- ✅ Bounding box 기반 지리적 쿼리 최적화

---

## ⚠️ 발견된 문제점 및 개선 필요 사항

### 🔴 Critical Issues

#### 1. **의존성 누락**
```typescript
// scripts/publish-queue.ts:4
import { z } from "zod";
```
- **문제**: `zod` 패키지가 `package.json`에 없음
- **영향**: 스크립트 실행 시 오류 발생
- **해결**: `npm install zod` 필요

#### 2. **중복 코드**
```typescript
// src/app/pharmacy/[id]/page.tsx:321-353
// "추가 안내" 섹션이 두 번 렌더링됨
```
- **문제**: 동일한 섹션이 중복 렌더링
- **영향**: 불필요한 DOM 생성, SEO에 부정적
- **해결**: 중복 제거 필요

#### 3. **데이터 제한 문제**
```typescript
// src/lib/data/pharmacies.ts:135
.limit(5000);
```
- **문제**: `getAllPharmacyHpids`에서 5000건으로 제한
- **영향**: 약국이 5000개 이상일 경우 누락
- **해결**: 페이지네이션 또는 전체 조회로 변경

### 🟡 Medium Priority Issues

#### 4. **에러 핸들링 개선**
- 일부 함수에서 에러를 단순히 `console.error`만 하고 있음
- 사용자에게 더 명확한 에러 메시지 제공 필요
- 에러 바운더리 추가 고려

#### 5. **타입 안정성**
```typescript
// src/app/pharmacy/[id]/page.tsx:77, 80
(faq as any).question ?? (faq as any).q
```
- **문제**: `any` 타입 사용으로 타입 안정성 저하
- **해결**: 명확한 타입 정의 필요

#### 6. **환경 변수 검증**
- 런타임에 환경 변수가 없을 때의 처리 개선 필요
- 개발 환경에서 더 명확한 에러 메시지

### 🟢 Low Priority / 개선 제안

#### 7. **코드 중복**
- `distanceKm` 함수가 여러 파일에 중복 정의됨
- `pharmacies.ts`와 `pharmacy/[id]/page.tsx`에 동일 로직

#### 8. **테스트 코드 부재**
- 단위 테스트, 통합 테스트 추가 필요
- 특히 비즈니스 로직 (`hours.ts`, `pharmacies.ts`)

#### 9. **성능 모니터링**
- API 응답 시간 모니터링
- 에러 추적 시스템 (Sentry 등) 고려

#### 10. **접근성 (A11y)**
- 일부 버튼에 `aria-label` 추가 필요
- 키보드 네비게이션 개선

---

## 📊 코드 품질 지표

| 항목 | 평가 | 비고 |
|------|------|------|
| 타입 안정성 | ⭐⭐⭐⭐ | 일부 `any` 사용 |
| 에러 핸들링 | ⭐⭐⭐ | 기본적인 처리만 |
| 코드 재사용성 | ⭐⭐⭐⭐ | 컴포넌트화 잘됨 |
| 성능 최적화 | ⭐⭐⭐⭐ | SSR, 메모이제이션 활용 |
| SEO 최적화 | ⭐⭐⭐⭐⭐ | 매우 잘 구현됨 |
| 접근성 | ⭐⭐⭐ | 개선 여지 있음 |
| 테스트 커버리지 | ⭐ | 테스트 코드 없음 |

---

## 🚀 앞으로의 개발 계획

### Phase 1: 버그 수정 및 안정화 (즉시)

1. **의존성 추가**
   ```bash
   npm install zod
   ```

2. **중복 코드 제거**
   - `pharmacy/[id]/page.tsx`의 중복 섹션 제거

3. **데이터 제한 해결**
   - `getAllPharmacyHpids` 함수 개선 (페이지네이션 또는 전체 조회)

4. **타입 안정성 개선**
   - `any` 타입 제거 및 명확한 타입 정의

### Phase 2: PLAN.md 구현 완료 (단기)

#### 2.1 사이트맵 인덱스 확장 ✅ (이미 구현됨)
- `generateSitemaps`로 10k 청크 분할
- 동적 sitemap 생성

#### 2.2 페이지네이션 노출 ✅ (이미 구현됨)
- 50개/페이지 설정
- SSR 페이지네이터 렌더링

#### 2.3 내부링크/AEO 유지 ✅ (이미 구현됨)
- 상세 페이지 간 링크
- 페이지네이션 링크 HTML 노출

#### 2.4 발행 스케줄 시스템 (구현 필요)
- **목표**: 하루 최대 10건 자동 발행
- **구현 내용**:
  - `content_queue` 테이블 활용
  - Cron job 또는 스케줄러 설정
  - `publish-queue.ts` 스크립트 자동화
  - 발행 우선순위 로직

### Phase 3: 기능 개선 (중기)

#### 3.1 콘텐츠 관리 시스템
- [ ] 콘텐츠 큐 관리 대시보드
- [ ] 발행 상태 모니터링
- [ ] 수동 발행/수정 기능

#### 3.2 검색 기능 강화
- [ ] 약국명 검색
- [ ] 주소 기반 검색
- [ ] 자동완성 기능

#### 3.3 지도 통합
- [ ] 지도 뷰 추가 (네이버/카카오 지도)
- [ ] 마커 클러스터링
- [ ] 경로 안내

#### 3.4 사용자 피드백
- [ ] 영업 정보 오류 신고
- [ ] 리뷰/평점 시스템 (선택적)

### Phase 4: 성능 및 모니터링 (중장기)

#### 4.1 성능 최적화
- [ ] 이미지 최적화 (Next.js Image)
- [ ] 코드 스플리팅 개선
- [ ] 캐싱 전략 (Redis 고려)

#### 4.2 모니터링 및 분석
- [ ] Google Analytics 통합 (이미 설정됨)
- [ ] 에러 추적 (Sentry)
- [ ] 성능 모니터링 (Vercel Analytics)

#### 4.3 테스트 코드 작성
- [ ] 단위 테스트 (Jest/Vitest)
- [ ] 통합 테스트
- [ ] E2E 테스트 (Playwright)

### Phase 5: 확장 기능 (장기)

#### 5.1 다국어 지원
- [ ] 영어 버전 추가
- [ ] i18n 라이브러리 통합

#### 5.2 PWA 지원
- [ ] Service Worker
- [ ] 오프라인 지원
- [ ] 푸시 알림 (선택적)

#### 5.3 API 공개
- [ ] 공개 API 문서화
- [ ] Rate limiting
- [ ] API 키 관리

---

## 📝 우선순위별 작업 목록

### 🔥 긴급 (이번 주)
1. ✅ `zod` 의존성 추가
2. ✅ 중복 섹션 제거
3. ✅ `getAllPharmacyHpids` 제한 해결
4. ✅ 타입 안정성 개선

### ⚡ 중요 (이번 달)
1. 발행 스케줄 시스템 구현
2. 에러 핸들링 개선
3. 환경 변수 검증 강화
4. 코드 중복 제거 (distanceKm 등)

### 📈 개선 (다음 분기)
1. 테스트 코드 작성
2. 검색 기능 추가
3. 지도 통합
4. 성능 모니터링 도입

---

## 🎯 성공 지표 (KPI)

### SEO/AEO
- [ ] Google Search Console 노출 수 증가
- [ ] 상위 노출 키워드 수 증가
- [ ] 클릭률 (CTR) 개선
- [ ] 평균 세션 시간 증가

### 사용자 경험
- [ ] 페이지 로딩 시간 < 2초
- [ ] 모바일 사용자 비율 > 70%
- [ ] 이탈률 < 50%

### 기술적
- [ ] Lighthouse 점수 > 90
- [ ] 에러율 < 0.1%
- [ ] API 응답 시간 < 500ms

---

## 📚 참고 자료

- [Next.js Sitemap Documentation](https://nextjs.org/docs/app/api-reference/file-conventions/metadata/sitemap)
- [Schema.org Pharmacy](https://schema.org/Pharmacy)
- [Google AEO 가이드](https://developers.google.com/search/docs/appearance/answer-engine-optimization)

---

**작성일**: 2024년  
**검토자**: AI Code Reviewer  
**다음 검토 예정일**: 주요 변경사항 발생 시

